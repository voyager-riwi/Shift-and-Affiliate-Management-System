@{
ViewData["Title"] = "Registro de Nuevo Afiliado";
}

<div class="container mt-4">
    <h1 class="mb-4">Registro de Nuevo Afiliado</h1>

    <form id="registerForm">
        <div class="row">
            <div class="col-md-6">
                <h4>1. Ingrese los Datos</h4>
                <div class="mb-3">
                    <label for="fullName" class="form-label">Nombre Completo</label>
                    <input type="text" class="form-control" id="fullName" required>
                </div>
                <div class="mb-3">
                    <label for="documentId" class="form-label">Documento</label>
                    <input type="text" class="form-control" id="documentId" required>
                </div>
                <div class="mb-3">
                    <label for="email" class="form-label">Correo Electrónico</label>
                    <input type="email" class="form-control" id="email">
                </div>
                <div class="mb-3">
                    <label for="phoneNumber" class="form-label">Teléfono</label>
                    <input type="text" class="form-control" id="phoneNumber">
                </div>
            </div>
            <div class="col-md-6">
                <h4>2. Capture la Foto</h4>
                <div class="text-center">
                    <video id="video" width="320" height="240" autoplay class="border bg-light"></video>
                    <br />
                    <button type="button" id="captureButton" class="btn btn-secondary mt-2">Capturar</button>
                    <h5 class="mt-3">Vista Previa:</h5>
                    <img id="preview" width="320" height="240" class="border" />
                </div>
            </div>
        </div>
        <hr class="my-4">
        <div class="d-grid">
            <button type="button" id="btnGuardarAfiliado" class="btn btn-primary btn-lg">Guardar Afiliado</button>
        </div>
    </form>
</div>

<canvas id="canvas" width="320" height="240" style="display:none;"></canvas>

@section Scripts {
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const captureButton = document.getElementById('captureButton');
        const preview = document.getElementById('preview');
        const saveButton = document.getElementById('btnGuardarAfiliado');
        let photoBase64 = null;

        // Iniciar la cámara
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => { video.srcObject = stream; })
            .catch(err => {
                console.error("Error al acceder a la cámara: ", err);
                alert("No se pudo acceder a la cámara. Verifique los permisos.");
            });

        // Capturar la foto
        captureButton.addEventListener('click', () => {
            const context = canvas.getContext('2d'); // <-- CORRECCIÓN: Era 'd', debe ser '2d'
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const dataUrl = canvas.toDataURL('image/png');
            preview.src = dataUrl;
            photoBase64 = dataUrl;
        });

        // Lógica para guardar el afiliado
        saveButton.addEventListener('click', async () => {
            if (!photoBase64) {
                alert("Por favor, capture una foto antes de guardar.");
                return;
            }

            const affiliateData = {
                fullName: document.getElementById('fullName').value,
                documentId: document.getElementById('documentId').value,
                email: document.getElementById('email').value,
                phoneNumber: document.getElementById('phoneNumber').value,
                photoBase64: photoBase64
            };

            try {
                const response = await fetch('/api/Affiliates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(affiliateData)
                });

                if (!response.ok) {
                    throw new Error(`Error del servidor: ${response.status}`);
                }

                const nuevoAfiliado = await response.json();
                alert(`¡Afiliado guardado con éxito! Id: ${nuevoAfiliado.id}`);

                document.getElementById('registerForm').reset();
                preview.src = '';
                photoBase64 = null;

            } catch (error) {
                console.error('Error al guardar:', error);
                alert('No se pudo guardar el afiliado.');
            }
        });
    });
</script>
}